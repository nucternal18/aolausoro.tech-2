name: Node.js CI

on:
  push:
    branches: [main]

env:
  HUSKY: 0

jobs:
  build:
    runs-on: self-hosted

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      # IMPORTANT: Expose pnpm to GitHub Actions PATH
      - name: Add pnpm to PATH
        run: |
          export PNPM_HOME="$HOME/.local/share/pnpm"
          echo "PNPM_HOME=$PNPM_HOME" >> $GITHUB_ENV
          echo "PATH=$PNPM_HOME:$PATH" >> $GITHUB_ENV
          pnpm -v

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      # ENV SETUP
      - name: Create .env file
        run: |
          echo DATABASE_URL=${{ secrets.DATABASE_URL }} > .env
          cat .env

      - name: Create .env.local file
        run: |
          echo "CLOUDINARY_NAME=$CLOUDINARY_NAME" >> .env.local
          echo "CLOUDINARY_API_KEY=$CLOUDINARY_API_KEY" >> .env.local
          echo "CLOUDINARY_API_SECRET=$CLOUDINARY_API_SECRET" >> .env.local
          echo "NEXT_TELEMETRY_DISABLED=$NEXT_TELEMETRY_DISABLED" >> .env.local
          echo "NEXT_PUBLIC_RECAPTCHA_SITE_KEY=$NEXT_PUBLIC_RECAPTCHA_SITE_KEY" >> .env.local
          echo "RECAPTCHA_SITE_KEY=$RECAPTCHA_SITE_KEY" >> .env.local
          echo "REPO_TOKEN=$REPO_TOKEN" >> .env.local
          echo "RESEND_API_KEY=$RESEND_API_KEY" >> .env.local
          echo "CLERK_SECRET_KEY=$CLERK_SECRET_KEY" >> .env.local
          echo "NEXT_PUBLIC_CLERK_SIGN_IN_URL=$NEXT_PUBLIC_CLERK_SIGN_IN_URL" >> .env.local
          echo "CLERK_WEBHOOK_SECRET=$CLERK_WEBHOOK_SECRET" >> .env.local
          echo "NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL" >> .env.local
          echo "NEXT_PUBLIC_CLOUDINARY_NAME=$NEXT_PUBLIC_CLOUDINARY_NAME" >> .env.local
          echo "NEXT_PUBLIC_CLOUDINARY_PRESET=$NEXT_PUBLIC_CLOUDINARY_PRESET" >> .env.local
          echo "SENTRY_AUTH_TOKEN=$SENTRY_AUTH_TOKEN" >> .env.local
          cat .env.local
        env:
          CLOUDINARY_NAME: ${{ secrets.CLOUDINARY_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
          NEXT_TELEMETRY_DISABLED: ${{ secrets.NEXT_TELEMETRY_DISABLED }}
          NEXT_PUBLIC_RECAPTCHA_SITE_KEY: ${{ secrets.NEXT_PUBLIC_RECAPTCHA_SITE_KEY }}
          RECAPTCHA_SITE_KEY: ${{ secrets.RECAPTCHA_SITE_KEY }}
          REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          NEXT_PUBLIC_CLERK_SIGN_IN_URL: ${{ secrets.NEXT_PUBLIC_CLERK_SIGN_IN_URL }}
          CLERK_WEBHOOK_SECRET: ${{ secrets.CLERK_WEBHOOK_SECRET }}
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_CLOUDINARY_NAME: ${{ secrets.NEXT_PUBLIC_CLOUDINARY_NAME }}
          NEXT_PUBLIC_CLOUDINARY_PRESET: ${{ secrets.NEXT_PUBLIC_CLOUDINARY_PRESET }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}

      - name: Create .env.sentry-build-plugin file
        run: |
          echo "SENTRY_AUTH_TOKEN=$SENTRY_AUTH_TOKEN" > .env.sentry-build-plugin
          cat .env.sentry-build-plugin
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}

      # ---- PNPM WORKFLOW ----
      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Run ESLint
        run: pnpm lint

      - name: Generate Prisma client
        run: pnpm generate

      - name: Build
        run: pnpm build

      - name: Restart pm2
        run: pm2 restart portfolio-client

    env:
      CI: true